<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ableton Device Loader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls-panel {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-section h3 {
            margin-bottom: 15px;
            color: #4ecdc4;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ed573;
        }

        .status-dot.testing {
            background: #ffa502;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .add-device-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 15px;
        }

        input, select, button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
        }

        input, select {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .preset-buttons button {
            font-size: 12px;
            padding: 8px;
        }

        .file-input {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            min-height: 200px;
        }

        .device-btn {
            padding: 18px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .device-btn:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.2);
            border-color: #4ecdc4;
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.3);
        }

        .device-btn:active {
            transform: translateY(-1px);
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
        }

        .device-btn.loading {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            animation: pulse 1s infinite;
        }

        .device-btn .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ff4757;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .edit-mode .device-btn .remove-btn {
            display: flex;
        }

        .edit-mode .device-btn {
            border-color: #ff9a9e;
            background: rgba(255, 154, 158, 0.1);
        }

        .edit-mode .device-btn:hover {
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        .hidden {
            display: none !important;
        }

        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .session-id {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .controls-panel {
                grid-template-columns: 1fr;
            }
            
            .device-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ableton Device Loader</h1>
            <p>Universal remote control for Ableton Live devices</p>
            <p style="font-size: 14px; opacity: 0.8; margin-top: 10px;">
                üì± Realtime Database - instant device loading
            </p>
        </div>

        <div class="controls-panel">
            <div class="control-section">
                <h3>Session</h3>
                <div class="connection-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="connectionText">Connecting to realtime database...</span>
                </div>
                <div class="session-id">
                    <div>Session ID: <span id="sessionId">Generating...</span></div>
                    <div style="font-size: 10px; opacity: 0.7; margin-top: 5px;">
                        Share this ID with your Max device
                    </div>
                </div>
                <button onclick="generateNewSession()">New Session</button>
                <button onclick="testConnection()">Test Connection</button>
            </div>

            <div class="control-section">
                <h3>Add Device</h3>
                <div class="add-device-form">
                    <input type="text" id="deviceName" placeholder="Device name (e.g., Operator)">
                    <button onclick="addDevice()">Add</button>
                </div>
                <select id="categorySelect">
                    <option value="instruments">Instruments</option>
                    <option value="audio_effects">Audio Effects</option>
                    <option value="midi_effects">MIDI Effects</option>
                    <option value="custom">Custom</option>
                </select>
            </div>

            <div class="control-section">
                <h3>Presets & Mode</h3>
                <div class="mode-toggle" style="margin-bottom: 15px;">
                    <button id="modeToggle" onclick="toggleEditMode()" style="background: #4ecdc4; font-size: 12px;">
                        üìù Edit Mode: OFF
                    </button>
                </div>
                <div class="preset-buttons">
                    <button onclick="exportPreset()">Export Preset</button>
                    <button onclick="importPreset()">Import Preset</button>
                    <button onclick="resetToDefault()">Reset to Default</button>
                    <button onclick="clearAll()">Clear All</button>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".json" onchange="handleFileImport(event)">
                <div style="font-size: 10px; opacity: 0.7; margin-top: 8px;">
                    Toggle edit mode to add/remove devices
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('instruments')">Instruments</button>
            <button class="tab-btn" onclick="showTab('audio_effects')">Audio Effects</button>
            <button class="tab-btn" onclick="showTab('midi_effects')">MIDI Effects</button>
            <button class="tab-btn" onclick="showTab('custom')">Custom</button>
        </div>

        <div id="instruments" class="device-grid">
            <!-- Will be populated by JavaScript -->
        </div>

        <div id="audio_effects" class="device-grid hidden">
            <!-- Will be populated by JavaScript -->
        </div>

        <div id="midi_effects" class="device-grid hidden">
            <!-- Will be populated by JavaScript -->
        </div>

        <div id="custom" class="device-grid hidden">
            <!-- Will be populated by JavaScript -->
        </div>

        <div class="log" id="log">
            <div>Device Loader initializing...</div>
        </div>
    </div>

    <script>
        // Firebase Realtime Database configuration - YOUR REAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB0_6KxIa40hjrMBXIAFSmq-DbM0n3dV4c",
            authDomain: "ableton-device-loader.firebaseapp.com",
            projectId: "ableton-device-loader",
            databaseURL: "https://ableton-device-loader-default-rtdb.firebaseio.com",
            storageBucket: "ableton-device-loader.firebasestorage.app",
            messagingSenderId: "98237079129",
            appId: "1:98237079129:web:6806e8fa30eea38876d5e8"
        };

        // Default devices from your Max patch
        const DEFAULT_DEVICES = {
            instruments: [
                'Analog', 'Collision', 'Drift', 'Drum Rack', 'Drum Sampler', 'Electric', 
                'External Instrument', 'Impulse', 'Instrument Rack', 'Meld', 'Operator', 
                'Sampler', 'Simpler', 'Tension', 'Wavetable'
            ],
            audio_effects: [
                'Amp', 'Audio Effect Rack', 'Auto Filter', 'Auto Pan', 'Auto Shift', 
                'Beat Repeat', 'Cabinet', 'Channel EQ', 'Chorus-Ensemble', 'Compressor', 
                'Corpus', 'Delay', 'Drum Buss', 'Dynamic Tube', 'Echo', 'EQ Eight', 
                'EQ Three', 'Erosion', 'External Audio Effect', 'Filter Delay', 'Flanger', 
                'Frequency Shifter', 'Gate', 'Glue Compressor', 'Grain Delay', 'Hybrid Reverb', 
                'Limiter', 'Looper', 'Multiband Dynamics', 'OTT.adv', 'Overdrive', 'Pedal', 
                'Phaser', 'Redux', 'Resonators', 'Reverb', 'Roar', 'Saturator', 'Shifter', 
                'Spectral Resonator', 'Spectral Time', 'Spectrum', 'Tuner', 'Utility', 
                'Vinyl Distortion', 'Vocoder'
            ],
            midi_effects: [
                'Arpeggiator', 'CC Control', 'Chord', 'Note Length', 'Pitch', 'Random', 
                'Scale', 'Velocity'
            ],
            custom: []
        };

        // Global state
        let devices = {};
        let isConnected = false;
        let currentTab = 'instruments';
        let sessionId = '';
        let isEditMode = false;

        // Initialize everything
        function init() {
            log('Starting initialization...');
            
            // Generate or load session ID
            sessionId = localStorage.getItem('abletonSessionId') || generateSessionId();
            localStorage.setItem('abletonSessionId', sessionId);
            document.getElementById('sessionId').textContent = sessionId;
            
            // Load devices
            loadDevices();
            
            // Render UI
            renderAllDevices();
            
            // Test Realtime Database connection
            testConnection();
            
            log('Initialization complete');
        }

        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9);
        }

        function generateNewSession() {
            sessionId = generateSessionId();
            localStorage.setItem('abletonSessionId', sessionId);
            document.getElementById('sessionId').textContent = sessionId;
            log('Generated new session: ' + sessionId);
        }

        function testConnection() {
            log('Testing Firebase Realtime Database connection...');
            updateStatus('testing', 'Testing realtime database...');
            
            // Try to write a test value to Realtime Database
            const testUrl = `${firebaseConfig.databaseURL}/test.json`;
            
            fetch(testUrl, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    timestamp: new Date().toISOString(),
                    test: 'connection'
                })
            }).then(response => {
                if (response.ok) {
                    log('‚úÖ Firebase Realtime Database connection successful!');
                    updateStatus('connected', 'Connected to realtime database');
                    isConnected = true;
                } else {
                    throw new Error(`Server responded with status ${response.status}`);
                }
            }).catch((error) => {
                log('‚ùå Firebase Realtime Database connection failed: ' + error.message);
                updateStatus('disconnected', 'Realtime database connection failed');
                isConnected = false;
            });
        }

        function loadDevices() {
            const saved = localStorage.getItem('abletonDevices');
            
            if (saved) {
                try {
                    devices = JSON.parse(saved);
                    log('Loaded saved devices');
                } catch (e) {
                    log('Error loading saved devices, using defaults');
                    devices = JSON.parse(JSON.stringify(DEFAULT_DEVICES));
                }
            } else {
                log('No saved devices, loading defaults');
                devices = JSON.parse(JSON.stringify(DEFAULT_DEVICES));
                saveDevices();
            }

            // Ensure all categories exist
            if (!devices.instruments) devices.instruments = DEFAULT_DEVICES.instruments.slice();
            if (!devices.audio_effects) devices.audio_effects = DEFAULT_DEVICES.audio_effects.slice();
            if (!devices.midi_effects) devices.midi_effects = DEFAULT_DEVICES.midi_effects.slice();
            if (!devices.custom) devices.custom = [];

            log(`Loaded ${devices.instruments.length} instruments, ${devices.audio_effects.length} audio effects, ${devices.midi_effects.length} MIDI effects`);
        }

        function saveDevices() {
            localStorage.setItem('abletonDevices', JSON.stringify(devices));
            log('Devices saved to storage');
        }

        function renderAllDevices() {
            log('Rendering all devices...');
            
            Object.keys(devices).forEach(category => {
                renderCategory(category);
            });
        }

        function renderCategory(category) {
            const container = document.getElementById(category);
            if (!container) {
                log(`Warning: No container found for ${category}`);
                return;
            }

            container.innerHTML = '';

            if (!devices[category] || devices[category].length === 0) {
                container.innerHTML = `<div class="empty-state">No ${category.replace('_', ' ')} added yet. Use "Reset to Default" to load standard devices.</div>`;
                return;
            }

            devices[category].forEach(deviceName => {
                const btn = document.createElement('div');
                btn.className = 'device-btn';
                btn.innerHTML = `
                    ${deviceName}
                    <button class="remove-btn" onclick="removeDevice('${category}', '${deviceName}')" title="Remove">√ó</button>
                `;
                btn.onclick = (e) => {
                    if (e.target.classList.contains('remove-btn')) return;
                    
                    // In edit mode, don't send device - just select for editing
                    if (isEditMode) {
                        // Could add selection highlighting here in the future
                        return;
                    }
                    
                    // In operational mode, send the device immediately
                    loadDevice(deviceName);
                };
                container.appendChild(btn);
            });

            log(`Rendered ${devices[category].length} devices in ${category}`);
        }

        function showTab(tabName) {
            // Hide all grids
            document.querySelectorAll('.device-grid').forEach(grid => {
                grid.classList.add('hidden');
            });
            
            // Show selected grid
            const selectedGrid = document.getElementById(tabName);
            if (selectedGrid) {
                selectedGrid.classList.remove('hidden');
            }
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate clicked button
            const clickedBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => 
                btn.textContent.toLowerCase().includes(tabName.replace('_', ' '))
            );
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }
            
            currentTab = tabName;
            log(`Switched to ${tabName} tab`);
        }

        function addDevice() {
            const name = document.getElementById('deviceName').value.trim();
            const category = document.getElementById('categorySelect').value;
            
            if (!name) {
                alert('Please enter a device name');
                return;
            }
            
            if (!devices[category]) {
                devices[category] = [];
            }
            
            if (devices[category].includes(name)) {
                alert('Device already exists in this category');
                return;
            }
            
            devices[category].push(name);
            saveDevices();
            renderCategory(category);
            
            document.getElementById('deviceName').value = '';
            log(`Added ${name} to ${category}`);
        }

        function removeDevice(category, deviceName) {
            if (devices[category]) {
                devices[category] = devices[category].filter(d => d !== deviceName);
                saveDevices();
                renderCategory(category);
                log(`Removed ${deviceName} from ${category}`);
            }
        }

        function loadDevice(deviceName) {
            if (!isConnected) {
                alert('Not connected to realtime database. Check your internet connection.');
                return;
            }

            if (!sessionId) {
                alert('No session ID available!');
                return;
            }

            // Visual feedback
            const btn = Array.from(document.querySelectorAll('.device-btn')).find(b => 
                b.textContent.includes(deviceName)
            );
            if (btn) {
                btn.classList.add('loading');
                setTimeout(() => btn.classList.remove('loading'), 2000);
            }
            
            log(`Sending device "${deviceName}" to realtime database...`);
            
            // Generate unique request ID
            const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            
            // Send device request to Firebase Realtime Database
            const realtimeUrl = `${firebaseConfig.databaseURL}/device_requests/${sessionId}/${requestId}.json`;
            
            fetch(realtimeUrl, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(deviceName)
            }).then(response => {
                if (response.ok) {
                    log(`‚úÖ Device request sent: ${deviceName} (ID: ${requestId})`);
                    log('‚ö° Max should load this device instantly!');
                } else {
                    throw new Error(`Server responded with status ${response.status}`);
                }
            }).catch((error) => {
                log(`‚ùå Error sending device request: ${error.message}`);
            });
        }

        // EDIT MODE FUNCTIONS
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const body = document.body;
            const toggleBtn = document.getElementById('modeToggle');
            
            if (isEditMode) {
                body.classList.add('edit-mode');
                toggleBtn.innerHTML = 'üîí Edit Mode: ON';
                toggleBtn.style.background = '#ff4757';
                log('üìù Edit mode enabled - tap devices to remove them');
            } else {
                body.classList.remove('edit-mode');
                toggleBtn.innerHTML = 'üìù Edit Mode: OFF';
                toggleBtn.style.background = '#4ecdc4';
                log('‚ö° Operational mode - tap devices to send them');
            }
        }

        // PRESET FUNCTIONS
        function exportPreset() {
            const presetData = {
                name: `Ableton Device Preset - ${new Date().toLocaleDateString()}`,
                timestamp: new Date().toISOString(),
                version: "1.0",
                devices: devices
            };

            const jsonString = JSON.stringify(presetData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `ableton-preset-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('‚úÖ Preset exported successfully');
        }

        function importPreset() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const presetData = JSON.parse(e.target.result);
                    
                    if (!presetData.devices) {
                        alert('Invalid preset file: Missing devices data');
                        return;
                    }

                    // Confirm import
                    if (confirm(`Import preset "${presetData.name || 'Unknown'}"? This will replace your current devices.`)) {
                        devices = presetData.devices;
                        
                        // Ensure all categories exist
                        if (!devices.instruments) devices.instruments = [];
                        if (!devices.audio_effects) devices.audio_effects = [];
                        if (!devices.midi_effects) devices.midi_effects = [];
                        if (!devices.custom) devices.custom = [];

                        saveDevices();
                        renderAllDevices();
                        
                        log(`‚úÖ Preset imported: ${presetData.name || 'Unknown'}`);
                    }
                } catch (error) {
                    alert('Error reading preset file: ' + error.message);
                    log('‚ùå Error importing preset: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Clear the input so the same file can be selected again
            event.target.value = '';
        }

        function resetToDefault() {
            if (confirm('Reset to default devices? This will replace all your current devices.')) {
                devices = JSON.parse(JSON.stringify(DEFAULT_DEVICES));
                saveDevices();
                renderAllDevices();
                log('‚úÖ Reset to default devices');
            }
        }

        function clearAll() {
            if (confirm('Clear all devices? This cannot be undone.')) {
                devices = {
                    instruments: [],
                    audio_effects: [],
                    midi_effects: [],
                    custom: []
                };
                saveDevices();
                renderAllDevices();
                log('‚úÖ All devices cleared');
            }
        }

        function updateStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const textEl = document.getElementById('connectionText');
            
            if (dot) {
                dot.className = `status-dot`;
                if (status === 'connected') {
                    dot.classList.add('connected');
                } else if (status === 'testing') {
                    dot.classList.add('testing');
                }
            }
            if (textEl) textEl.textContent = text;
        }

        function log(message, data = null) {
            const logEl = document.getElementById('log');
            if (logEl) {
                const entry = document.createElement('div');
                const timestamp = new Date().toLocaleTimeString();
                
                if (data) {
                    entry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message} ${JSON.stringify(data)}`;
                } else {
                    entry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
                }
                
                logEl.appendChild(entry);
                logEl.scrollTop = logEl.scrollHeight;
            }
            console.log(message, data);
        }

        // Handle Enter key in device name input
        document.addEventListener('DOMContentLoaded', function() {
            const deviceNameInput = document.getElementById('deviceName');
            if (deviceNameInput) {
                deviceNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addDevice();
                    }
                });
            }
        });

        // Start everything when page loads
        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('load', init);
    </script>
</body>
</html>